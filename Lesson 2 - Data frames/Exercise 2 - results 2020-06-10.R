### R School
### 6-10-2020
### Lesson 2 - Exercise results

# First I have a set up like I usually use in my scripts
##### Load packages #####
library(ComplexHeatmap)

##### Set file locations #####
# Location of RNA-Seq data file to read in
rsfile <- "G:/Shared drives/Ethylene RNA Seq experiments/Data - DO NOT EDIT FILES/DESeq2/06 logFC cutoff 0_5/03 Ethylene vs. ACC comparisons/ethylene vs ACC in Col-0 - sig results - with summary columns.csv"

# Location of ACC 449 list
mafile <- "G:/Shared drives/R School/Lesson 2 - Data frames/data/ACC449.csv"

# Location to save output of script
saveloc <- "G:/Shared drives/R School/Lesson 2 - Data frames/exercise output/"

##### Set global options - heatmaps #####
# These are settings for the heatmap generated at the end
# I have several heatmaps in my RNA-Seq script, so I put all the settings at the top of the script

# Set scale for text
txtsize <- 1.5

# Set color scale
scale <- seq(-2.5, 2.5, 0.01)
# Generate color function
colfunc <- colorRampPalette(c("blue", "white", "red"))
colfunc <- circlize::colorRamp2(scale, colfunc(length(scale)))

# Generate larger legend to add in Illustrator
png(paste0(saveloc, "legend.png"), width = 100, height = 200)
draw(Legend(col_fun = colfunc,
            title = "logFC",
            legend_height = unit(40, "mm"),
            grid_width = unit(10, "mm"),
            labels_gp = gpar(cex = 1.5),
            title_gp = gpar(cex = 1.5),
            title_gap = unit(3, "mm")
            ))
dev.off()

# Labels for bottom of heatmap
anno.treat <- columnAnnotation(time = anno_mark(at = c(1:6),
                                                as.character(rep(c(1, 4, 24), 2)),
                                                labels_rot = 0,
                                                labels_gp = gpar(cex = txtsize),
                                                link_height = unit(2, "mm"),
                                                link_gp = gpar(col = "white")),
                               treatcol = c(rep("ethylene", 3), rep("ACC", 3)),
                               treat = anno_mark(at = c(2, 5),
                                                 labels = c("ethylene", "ACC"),
                                                 labels_rot = 0,
                                                 labels_gp = gpar(cex = txtsize),
                                                 link_height = unit(4, "mm"),
                                                 link_gp = gpar(col = "white")),
                               col = list(treatcol = c("ACC" = "black",
                                                       "ethylene" = "grey")),
                               simple_anno_size = unit(2, "mm"),
                               show_legend = FALSE,
                               show_annotation_name = FALSE
)



##### Part 1 - Read in data #####
rsdat <- read.csv(rsfile, row.names = 1)

head(rsdat)

malist <- read.csv(mafile, header = FALSE)

head(malist)

##### Part 2 #####
# Pull out RNA-Seq data for genes also in the 449 (malist)
rsdat <- rsdat[rownames(rsdat) %in% malist$V1,]

##### Part 3 #####
# Sort the results by the allsum column
rsdat <- rsdat[order(rsdat$allsum),]

##### Part 4 #####
# Count things that respond to ethylene, ACC, or both
rsdat <- rsdat[which(rsdat$eth.sum != "n" | rsdat$acc.sum != "n"),]

table(rsdat$allsum)

##### Part 5 #####
# Pull out only the logFC values for making a heatmap and convert to a matrix
rsdat <- rsdat[,grep("logFC",colnames(rsdat))]
# I added an additional line to remove the "max" columns
rsdat <- rsdat[,-grep("max", colnames(rsdat))]
heatmap(as.matrix(rsdat))

##### Part 6 - Heatmap #####
# This is a simplified version of the heatmap I generated for the manuscript using the ComplexHeatmaps package:
png(paste0(saveloc, "ethylene vs. ACC - results for ACC 449.png"), width = 450, height = 700)
Heatmap(as.matrix(rsdat),
        name = "logFC",
        cluster_columns = FALSE,
        show_row_names = FALSE,
        show_row_dend = FALSE,
        col = colfunc,
        bottom_annotation = anno.treat,
        column_labels = rep("", 6),
        width = unit(4, "in")
)
dev.off()